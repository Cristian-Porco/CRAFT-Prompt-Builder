<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>CRAFT Prompt Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --stroke:#e5e9f2; --muted:#41536b; --accent:#1f6feb; --text:#0b1a2b;
      --badge-start:#8ab4ff; --badge-end:#1f6feb; --badge-shadow:rgba(31,111,235,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; min-height:100vh; align-items:center; justify-content:center;
    }
    main{width:100%; max-width:760px; padding:24px}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:16px;
      padding:0; box-shadow:0 6px 24px rgba(10,22,50,.06);
      display:flex; flex-direction:column;
    }
    .card-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 20px; border-bottom:1px solid var(--stroke); background:#f0f4fb;
      border-top-left-radius:16px; border-top-right-radius:16px;
    }
    .header-left{display:flex; align-items:center; gap:14px}
    .card-header h2{margin:0; font-size:18px}
    .donate-btn{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      background:var(--accent); color:#fff; padding:8px 12px; border-radius:10px; font-weight:600;
    }
    .donate-btn:hover{filter:brightness(1.05)}
    .card-body{padding:24px}
    .hidden{display:none}
    p{margin:0 0 12px; color:var(--muted)}
    textarea,input,select{
      width:100%; background:#fbfdff; border:1px solid #d6deeb; border-radius:10px;
      color:var(--text); padding:12px; font-size:15px; outline:none;
    }
    label{font-size:14px; font-weight:600; margin-top:12px; display:block}
    button{
      margin-top:18px; background:var(--accent); border:none; color:white;
      padding:12px 18px; border-radius:10px; font-size:15px; cursor:pointer; align-self:flex-end;
    }
    button:hover{filter:brightness(1.05)}
    .spinner{
      border:4px solid #d6deeb; border-top:4px solid var(--accent); border-radius:50%;
      width:46px; height:46px; animation:spin 1s linear infinite; margin:0 auto;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    pre{
      background:#fbfdff; border:1px solid #d6deeb; border-radius:12px;
      padding:18px; white-space:pre-wrap; font-size:14px; line-height:1.45;
    }
    .inline-hint{font-size:12px; color:#5b6b82}

    .step-badge{
      width:46px; height:46px; min-width:46px;
      border-radius:50%;
      background: radial-gradient(120% 120% at 80% 20%, var(--badge-start) 0%, var(--badge-end) 60%, #124dbd 100%);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:800; font-size:20px;
      box-shadow: 0 10px 18px var(--badge-shadow), inset 0 2px 6px rgba(255,255,255,.25);
    }
    @media (min-width: 680px){
      .step-badge{ width:56px; height:56px; font-size:24px; }
      .card-header h2{ font-size:20px; }
    }

    .fields{display:grid; gap:18px}
    .field{
      border:1px solid #e6ecf7; background:#fff; border-radius:12px; padding:14px 16px;
    }
    .field-title{font-size:15px; font-weight:700; margin-bottom:6px}
    .field-desc{font-size:12px; color:#5b6b82; margin-bottom:8px}
  </style>
</head>
<body>
  <main>
    <!-- STEP 1 -->
    <section class="card" id="step1">
      <div class="card-header">
        <div class="header-left">
          <div class="step-badge">1</div>
          <h2>Che cosa vuoi ottenere?</h2>
        </div>
        <a class="donate-btn" href="https://www.paypal.com/donate/?hosted_button_id=MLFQ45F7PRK4W" target="_blank">Dona con PayPal</a>
      </div>
      <div class="card-body">
        <p>Descrivi l’argomento o il tema del prompt C.R.A.F.T.</p>
        <textarea id="goal" rows="6" placeholder="Es: Voglio un prompt per generare un sito stile WhatsApp..."></textarea>
        <button id="toStep2">Continua</button>
      </div>
    </section>

    <!-- LOADING -->
    <section class="card hidden" id="loading">
      <div class="card-header">
        <div class="header-left">
          <div class="step-badge">⏳</div>
          <h2>Elaborazione…</h2>
        </div>
        <a class="donate-btn" href="https://www.paypal.com/donate/?hosted_button_id=MLFQ45F7PRK4W" target="_blank">Dona con PayPal</a>
      </div>
      <div class="card-body" style="text-align:center">
        <div class="spinner"></div>
        <p style="margin-top:12px">Attendi qualche secondo…</p>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="card hidden" id="step2">
      <div class="card-header">
        <div class="header-left">
          <div class="step-badge">2</div>
          <h2>Definisci i dettagli</h2>
        </div>
        <a class="donate-btn" href="https://www.paypal.com/donate/?hosted_button_id=MLFQ45F7PRK4W" target="_blank">Dona con PayPal</a>
      </div>
      <div class="card-body">
        <form id="dynamicForm" class="fields"></form>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="card hidden" id="step3">
      <div class="card-header">
        <div class="header-left">
          <div class="step-badge">3</div>
          <h2>Prompt finale</h2>
        </div>
        <a class="donate-btn" href="https://www.paypal.com/donate/?hosted_button_id=MLFQ45F7PRK4W" target="_blank">Dona con PayPal</a>
      </div>
      <div class="card-body">
        <pre id="finalPrompt"></pre>
        <button id="restart">Ricomincia</button>
      </div>
    </section>
  </main>

<script>
const step1=document.getElementById('step1');
const step2=document.getElementById('step2');
const step3=document.getElementById('step3');
const loading=document.getElementById('loading');
const dynamicForm=document.getElementById('dynamicForm');
const finalPrompt=document.getElementById('finalPrompt');
const goalEl=document.getElementById('goal');
const restartBtn=document.getElementById('restart');
let history=[];

function show(el){el.classList.remove('hidden');}
function hide(el){el.classList.add('hidden');}

async function callAPI(responseFormat='text'){
  const res=await fetch('api/communication.php',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({messages:history,responseFormat})
  });
  const data=await res.json();
  if(!res.ok){throw new Error((data&&data.error&&data.error.message)||'Errore API');}
  return data;
}

// STEP 1 -> campi
document.getElementById('toStep2').onclick=async()=>{
  const content=goalEl.value.trim();
  if(!content){goalEl.focus();return;}
  hide(step1);show(loading);

  history.push({role:'user',content:''});
  try{await callAPI('text');}catch(e){console.warn('Bootstrap fallito:',e.message);}
  history.push({role:'user',content});

  let data;
  try{data=await callAPI('json_object');}catch(e){hide(loading);show(step1);alert('Errore: '+e.message);return;}
  hide(loading);

  try{
    const parsed=JSON.parse(data.text);
    if(parsed.fields){renderForm(parsed.fields);show(step2);}
    else if(parsed.direct_prompt){showFinal(parsed.direct_prompt);}
    else{showFinal('Risposta inattesa:\n'+data.text);}
  }catch(err){showFinal('JSON non valido:\n'+(data.text??''));}
};

function renderForm(fields){
  dynamicForm.innerHTML='';
  fields.forEach(f=>{
    const field=document.createElement('div');
    field.className='field';

    const title=document.createElement('div');
    title.className='field-title';
    title.textContent=f.display_name||f.name;
    field.appendChild(title);

    if(f.description){
      const desc=document.createElement('div');
      desc.className='field-desc';
      desc.textContent=f.description;
      field.appendChild(desc);
    }

    let input;
    if(f.type==='boolean'){input=document.createElement('input');input.type='checkbox';}
    else if(f.type==='enum'&&Array.isArray(f.options)){
      input=document.createElement('select');
      f.options.forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;input.appendChild(o);});
    }else if(f.type==='number'){input=document.createElement('input');input.type='number';input.step='any';}
    else{input=document.createElement('input');input.type='text';}
    input.id='f__'+f.name;
    input.placeholder=f.placeholder||'';
    if(f.default)input.value=f.default;
    field.appendChild(input);

    dynamicForm.appendChild(field);
  });

  const submit=document.createElement('button');
  submit.type='submit';submit.textContent='Genera Prompt';
  dynamicForm.appendChild(submit);
}

dynamicForm.onsubmit=async e=>{
  e.preventDefault();hide(step2);show(loading);
  const values={};
  Array.from(dynamicForm.elements).forEach(el=>{
    if(!el.id)return;
    const name=el.id.replace('f__','');
    values[name]=(el.type==='checkbox')?el.checked:el.value;
  });
  history.push({role:'user',content:JSON.stringify({values},null,2)});
  let data;
  try{data=await callAPI('text');}catch(e){hide(loading);show(step2);alert('Errore: '+e.message);return;}
  hide(loading);showFinal(data.text||'');
};

function showFinal(text){finalPrompt.textContent=text||'(nessun contenuto)';show(step3);}
restartBtn.onclick=()=>location.reload();
</script>
</body>
</html>